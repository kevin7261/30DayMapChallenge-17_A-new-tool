<script>
  /**
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   * ğŸ—ºï¸ MapTab.vue - MapLibre GL JS å°ç£ç¸£å¸‚ 3D åœ°åœ–çµ„ä»¶
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   *
   * @fileoverview
   * é€™æ˜¯ä¸€å€‹åŸºæ–¼ MapLibre GL JS çš„å°ç£ç¸£å¸‚ 3D åœ°åœ–è¦–è¦ºåŒ–çµ„ä»¶ã€‚
   * æœ¬çµ„ä»¶è² è²¬è¼‰å…¥ã€è™•ç†å’Œæ¸²æŸ“å°ç£ç¸£å¸‚é‚Šç•Œçš„ GeoJSON æ•¸æ“šï¼Œä¸¦æ”¯æŒ 3D è¦–è§’ã€‚
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 1. ç¸£å¸‚é‚Šç•Œæ¸²æŸ“ï¼š
   *    âœ“ è¼‰å…¥ ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   *    âœ“ ä»¥ 3D extrusion æ–¹å¼ç¹ªè£½æ‰€æœ‰å°ç£ç¸£å¸‚é‚Šç•Œ
   *
   * 2. è¦–è¦ºå…ƒç´ ï¼š
   *    âœ“ 3D ç«‹é«”ç¸£å¸‚å€åŸŸ
   *    âœ“ é»‘è‰²ç¸£å¸‚é‚Šç•Œç·š
   *    âœ“ ç°è‰²åœ°åœ–èƒŒæ™¯
   *
   * 3. äº¤äº’åŠŸèƒ½ï¼š
   *    âœ“ æ»¾è¼ªç¸®æ”¾æ§åˆ¶
   *    âœ“ æ‹–å‹•å¹³ç§»å°èˆª
   *    âœ“ å³éµæ‹–å‹•æ—‹è½‰è¦–è§’ï¼ˆ3Dï¼‰
   *    âœ“ å‚¾æ–œè¦–è§’æ§åˆ¶
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ¨ é…è‰²ä¸»é¡Œ
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ç°è‰²      #808080  â†’ åœ°åœ–èƒŒæ™¯
   * é»‘è‰²      #000000  â†’ ç¸£å¸‚é‚Šæ¡†
   * ç™½è‰²/è—è‰²æ¼¸å±¤      â†’ 3D ç¸£å¸‚å¡«å……
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ› ï¸ æŠ€è¡“æ£§
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @requires vue                 - Vue 3.2+ (Composition API)
   * @requires maplibre-gl         - MapLibre GL JS (3D åœ°åœ–åº«)
   * @requires @/stores/dataStore  - Pinia ç‹€æ…‹ç®¡ç†
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ æ•¸æ“šä¾†æº
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ç¸£å¸‚é‚Šç•Œæ•¸æ“šï¼šç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   * è·¯å¾‘ï¼špublic/data/geojson/ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ”§ ä½¿ç”¨æ–¹å¼
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * <MapTab @map-ready="handleMapReady" />
   *
   * @event map-ready - åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œè¿”å›åœ°åœ–å¯¦ä¾‹
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ ç¶­è­·è€…
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @author Kevin Cheng
   * @version 4.0.0
   * @since 2025
   * @license MIT
   *
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   */

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ ä¾è³´å°å…¥ (Dependencies Import)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Vue 3 æ ¸å¿ƒåŠŸèƒ½
  import { ref, onMounted, onUnmounted, nextTick } from 'vue';

  // MapLibre GL JS
  import maplibregl from 'maplibre-gl';
  import 'maplibre-gl/dist/maplibre-gl.css';

  // Pinia ç‹€æ…‹ç®¡ç†
  import { useDataStore } from '@/stores/dataStore';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¯ çµ„ä»¶å®šç¾© (Component Definition)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  export default {
    name: 'MapTab',

    // çµ„ä»¶è§¸ç™¼çš„äº‹ä»¶
    emits: [
      'map-ready', // åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œå‚³éåœ°åœ–å¯¦ä¾‹
    ],

    /**
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ğŸ¬ çµ„ä»¶è¨­ç½®å‡½æ•¸ (Component Setup Function)
     * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     * ä½¿ç”¨ Vue 3 Composition API è¨­ç½®çµ„ä»¶é‚è¼¯
     *
     * @param {Object} _ - Propsï¼ˆæœ¬çµ„ä»¶ä¸ä½¿ç”¨ï¼‰
     * @param {Object} context - è¨­ç½®ä¸Šä¸‹æ–‡
     * @param {Function} context.emit - äº‹ä»¶è§¸ç™¼å‡½æ•¸
     * @returns {Object} è¿”å›æ¨¡æ¿å¯ç”¨çš„éŸ¿æ‡‰å¼æ•¸æ“šå’Œæ–¹æ³•
     */
    setup(_, { emit }) {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¦ ç‹€æ…‹ç®¡ç†èˆ‡ä¾è³´ (State Management & Dependencies)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      // Pinia æ•¸æ“šå­˜å„²
      const dataStore = useDataStore();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ—ºï¸ åœ°åœ–ç›¸é—œè®Šæ•¸ (Map-Related Variables)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ– DOM å®¹å™¨å¼•ç”¨
       * @type {Ref<HTMLElement|null>}
       */
      const mapContainer = ref(null);

      /**
       * MapLibre GL åœ°åœ–å¯¦ä¾‹
       * @type {maplibregl.Map|null}
       */
      let map = null;

      /**
       * Popup å¯¦ä¾‹
       * @type {maplibregl.Popup|null}
       */
      let popup = null;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ›ï¸ æ§åˆ¶ç‹€æ…‹ (Control States)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * åœ°åœ–å°±ç·’ç‹€æ…‹æ¨™è¨˜
       * true = åœ°åœ–å·²åˆå§‹åŒ–å®Œæˆï¼Œfalse = å°šæœªåˆå§‹åŒ–
       * @type {Ref<boolean>}
       */
      const isMapReady = ref(false);

      /**
       * åœ°åœ–å®¹å™¨å”¯ä¸€ ID
       * ä½¿ç”¨éš¨æ©Ÿå­—ç¬¦ä¸²ç¢ºä¿å¤šå¯¦ä¾‹æ™‚ä¸æœƒè¡çª
       * @type {Ref<string>}
       */
      const mapContainerId = ref(`maplibre-map-${Math.random().toString(36).substr(2, 9)}`);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“Š GeoJSON æ•¸æ“šå„²å­˜ (GeoJSON Data Storage)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      /**
       * ç¸£å¸‚ GeoJSON æ•¸æ“š
       * ä¾†æºï¼šç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
       * @type {Ref<Object|null>}
       */
      const countyData = ref(null);

      /**
       * ğŸ“¥ è¼‰å…¥å°ç£ç¸£å¸‚ GeoJSON æ•¸æ“š
       */
      const loadCountyData = async () => {
        try {
          console.log('[MapTab] é–‹å§‹è¼‰å…¥å°ç£ç¸£å¸‚ GeoJSON æ•¸æ“š...');

          // è¼‰å…¥ç¸£å¸‚ GeoJSON æª”æ¡ˆ
          const countyResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson`
          );

          // æª¢æŸ¥éŸ¿æ‡‰
          if (!countyResponse.ok) {
            throw new Error(`ç¸£å¸‚æ•¸æ“šè¼‰å…¥å¤±æ•—: HTTP ${countyResponse.status}`);
          }

          // è§£æ JSON
          countyData.value = await countyResponse.json();

          console.log('[MapTab] å°ç£ç¸£å¸‚æ•¸æ“šè¼‰å…¥æˆåŠŸ');
          console.log('  - ç¸£å¸‚æ•¸é‡:', countyData.value.features?.length || 0);

          return true;
        } catch (error) {
          console.error('[MapTab] å°ç£ç¸£å¸‚æ•¸æ“šè¼‰å…¥å¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸ—ºï¸ æ·»åŠ  3D ç¸£å¸‚åœ–å±¤
       */
      const add3DCountyLayers = () => {
        if (!map || !countyData.value) {
          console.error('[MapTab] ç„¡æ³•æ·»åŠ åœ–å±¤: map=', !!map, 'countyData=', !!countyData.value);
          return;
        }

        try {
          console.log('[MapTab] é–‹å§‹æ·»åŠ  3D å°ç£ç¸£å¸‚åœ–å±¤');

          // æ·»åŠ æ•¸æ“šæº
          map.addSource('counties', {
            type: 'geojson',
            data: countyData.value,
          });

          // æ·»åŠ  3D extrusion åœ–å±¤
          map.addLayer({
            id: 'counties-3d',
            type: 'fill-extrusion',
            source: 'counties',
            paint: {
              'fill-extrusion-color': [
                'match',
                ['get', 'COUNTYNAME'],
                'è‡ºåŒ—å¸‚',
                '#FF6B6B',
                'æ–°åŒ—å¸‚',
                '#4ECDC4',
                'åŸºéš†å¸‚',
                '#45B7D1',
                'æ¡ƒåœ’å¸‚',
                '#96CEB4',
                'æ–°ç«¹å¸‚',
                '#FFEAA7',
                'æ–°ç«¹ç¸£',
                '#DFE6E9',
                'è‹—æ —ç¸£',
                '#74B9FF',
                'è‡ºä¸­å¸‚',
                '#A29BFE',
                'å½°åŒ–ç¸£',
                '#FD79A8',
                'å—æŠ•ç¸£',
                '#FDCB6E',
                'é›²æ—ç¸£',
                '#6C5CE7',
                'å˜‰ç¾©å¸‚',
                '#00B894',
                'å˜‰ç¾©ç¸£',
                '#00CEC9',
                'è‡ºå—å¸‚',
                '#E17055',
                'é«˜é›„å¸‚',
                '#0984E3',
                'å±æ±ç¸£',
                '#55EFC4',
                'å®œè˜­ç¸£',
                '#A8E6CF',
                'èŠ±è“®ç¸£',
                '#FFD93D',
                'è‡ºæ±ç¸£',
                '#FF8B94',
                'æ¾æ¹–ç¸£',
                '#B4A7D6',
                'é‡‘é–€ç¸£',
                '#F3A683',
                'é€£æ±Ÿç¸£',
                '#81ECEC',
                // é è¨­é¡è‰²ï¼ˆä»¥é˜²è¬ä¸€ï¼‰
                '#CCCCCC',
              ],
              'fill-extrusion-height': 50000, // 3D é«˜åº¦ (ç±³)
              'fill-extrusion-base': 0,
              'fill-extrusion-opacity': 0.8,
            },
          });

          // æ·»åŠ ç¸£å¸‚é‚Šç•Œç·šåœ–å±¤
          map.addLayer({
            id: 'counties-outline',
            type: 'line',
            source: 'counties',
            paint: {
              'line-color': '#000000',
              'line-width': 2,
            },
          });

          // å‰µå»ºæŒä¹…çš„ popup å¯¦ä¾‹
          popup = new maplibregl.Popup({
            closeButton: false,
            closeOnClick: false,
            className: 'county-popup',
          });

          // æ·»åŠ æ‡¸åœæ•ˆæœ
          map.on('mousemove', 'counties-3d', (e) => {
            map.getCanvas().style.cursor = 'pointer';

            if (e.features && e.features.length > 0) {
              const feature = e.features[0];
              const countyName = feature.properties.COUNTYNAME || 'æœªçŸ¥ç¸£å¸‚';

              // æ›´æ–° popup ä½ç½®å’Œå…§å®¹
              popup.setLngLat(e.lngLat).setHTML(`<strong>${countyName}</strong>`).addTo(map);
            }
          });

          map.on('mouseleave', 'counties-3d', () => {
            map.getCanvas().style.cursor = '';
            // ç§»é™¤ popup
            if (popup) {
              popup.remove();
            }
          });

          console.log('[MapTab] 3D å°ç£ç¸£å¸‚åœ–å±¤æ·»åŠ å®Œæˆ');
        } catch (error) {
          console.error('[MapTab] 3D å°ç£ç¸£å¸‚åœ–å±¤æ·»åŠ å¤±æ•—:', error);
        }
      };

      /**
       * ğŸ—ï¸ å‰µå»ºåœ°åœ–å¯¦ä¾‹
       * åˆå§‹åŒ– MapLibre GL åœ°åœ–ä¸¦è¨­å®šåŸºæœ¬é…ç½®
       */
      const createMap = () => {
        if (!mapContainer.value) return false;

        const rect = mapContainer.value.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
          console.warn('[MapTab] å®¹å™¨å°ºå¯¸ç‚ºé›¶ï¼Œå»¶é²åˆå§‹åŒ–');
          return false;
        }

        try {
          console.log('[MapTab] é–‹å§‹å‰µå»º MapLibre GL åœ°åœ–');

          // å‰µå»ºåœ°åœ–å¯¦ä¾‹
          map = new maplibregl.Map({
            container: mapContainer.value,
            style: {
              version: 8,
              sources: {
                'osm-tiles': {
                  type: 'raster',
                  tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                  tileSize: 256,
                  attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                },
              },
              layers: [
                {
                  id: 'background',
                  type: 'background',
                  paint: {
                    'background-color': '#808080', // ç°è‰²èƒŒæ™¯
                  },
                },
                {
                  id: 'osm-tiles-layer',
                  type: 'raster',
                  source: 'osm-tiles',
                  minzoom: 0,
                  maxzoom: 22,
                },
              ],
            },
            center: [120.9, 23.7], // å°ç£ä¸­å¿ƒåº§æ¨™
            zoom: 6.8,
            pitch: 60, // å‚¾æ–œè§’åº¦ (3D è¦–è§’)
            bearing: 0, // æ—‹è½‰è§’åº¦
            antialias: true, // æŠ—é‹¸é½’
          });

          // æ·»åŠ å°èˆªæ§åˆ¶å™¨ (ç¸®æ”¾æŒ‰éˆ•)
          map.addControl(new maplibregl.NavigationControl(), 'top-right');

          // åœ°åœ–è¼‰å…¥å®Œæˆå¾Œçš„è™•ç†
          map.on('load', () => {
            console.log('[MapTab] MapLibre GL åœ°åœ–è¼‰å…¥å®Œæˆ');
            isMapReady.value = true;

            // æ·»åŠ  3D ç¸£å¸‚åœ–å±¤
            add3DCountyLayers();

            // ä¿å­˜åœ°åœ–å¯¦ä¾‹åˆ° store
            dataStore.setMapInstance(map);

            // å°‡åœ°åœ–å¯¦ä¾‹å‚³éçµ¦çˆ¶çµ„ä»¶
            emit('map-ready', map);
          });

          console.log('[MapTab] MapLibre GL åœ°åœ–å‰µå»ºæˆåŠŸ');
          return true;
        } catch (error) {
          console.error('[MapTab] MapLibre GL åœ°åœ–å‰µå»ºå¤±æ•—:', error);
          return false;
        }
      };

      /**
       * ğŸš€ åˆå§‹åŒ–åœ°åœ–
       * å‰µå»ºåœ°åœ–ä¸¦è¼‰å…¥åˆå§‹æ•¸æ“š
       */
      const initMap = async () => {
        let attempts = 0;
        const maxAttempts = 20;

        // è¼‰å…¥å°ç£ç¸£å¸‚æ•¸æ“š
        const loaded = await loadCountyData();
        if (!loaded) {
          console.error('[MapTab] ç„¡æ³•è¼‰å…¥å°ç£ç¸£å¸‚æ•¸æ“š');
          return;
        }

        const tryCreateMap = async () => {
          if (attempts >= maxAttempts) {
            console.error('[MapTab] åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸');
            return;
          }

          attempts++;
          console.log(`[MapTab] å˜—è©¦å‰µå»ºåœ°åœ– (${attempts}/${maxAttempts})`);

          if (createMap()) {
            console.log('[MapTab] åœ°åœ–å‰µå»ºæˆåŠŸ');
          } else {
            console.log('[MapTab] åœ°åœ–å‰µå»ºå¤±æ•—ï¼Œ100ms å¾Œé‡è©¦');
            setTimeout(tryCreateMap, 100);
          }
        };

        tryCreateMap();
      };

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶æ›è¼‰
      onMounted(() => {
        nextTick(() => {
          initMap();
        });
      });

      // ğŸ§¹ ç”Ÿå‘½é€±æœŸï¼šçµ„ä»¶å¸è¼‰
      onUnmounted(() => {
        if (popup) {
          popup.remove();
          popup = null;
        }
        if (map) {
          map.remove();
          map = null;
        }
        isMapReady.value = false;
      });

      // ğŸ“¤ è¿”å›çµ„ä»¶å…¬é–‹çš„å±¬æ€§å’Œæ–¹æ³•
      return {
        mapContainer,
        mapContainerId,
      };
    },
  };
</script>

<template>
  <!-- ğŸ—ºï¸ åœ°åœ–ä¸»å®¹å™¨ -->
  <div id="map-container" class="h-100 w-100 position-relative bg-transparent z-0">
    <!-- ğŸ—ºï¸ MapLibre GL åœ°åœ–å®¹å™¨ -->
    <div :id="mapContainerId" ref="mapContainer" class="h-100 w-100"></div>
  </div>
</template>

<style scoped>
  @import '../assets/css/common.css';

  #map-container {
    overflow: hidden;
  }

  /* MapLibre GL åœ°åœ–å®¹å™¨æ¨£å¼ */
  :deep(.maplibregl-map) {
    font-family: 'Open Sans', 'Arial', sans-serif;
  }

  /* MapLibre GL æ§åˆ¶å™¨æ¨£å¼ */
  :deep(.maplibregl-ctrl-group) {
    background: rgba(0, 43, 127, 0.95);
    border: 1px solid #ffc61e;
  }

  :deep(.maplibregl-ctrl button) {
    background-color: rgba(0, 43, 127, 0.95);
    color: #ffc61e;
  }

  :deep(.maplibregl-ctrl button:hover) {
    background-color: rgba(0, 43, 127, 1);
  }

  /* MapLibre GL Popup æ¨£å¼ */
  :deep(.maplibregl-popup-content) {
    background: rgba(0, 43, 127, 0.95);
    color: #ffc61e;
    border: 2px solid #ffc61e;
    border-radius: 4px;
    padding: 12px 16px;
    font-size: 14px;
  }

  :deep(.maplibregl-popup-tip) {
    border-top-color: rgba(0, 43, 127, 0.95);
  }

  :deep(.maplibregl-popup-close-button) {
    color: #ffc61e;
    font-size: 20px;
    padding: 0 8px;
  }

  :deep(.maplibregl-popup-close-button:hover) {
    background-color: transparent;
    color: #ffffff;
  }
</style>
