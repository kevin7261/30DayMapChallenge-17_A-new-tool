<script>
  /**
   * ═══════════════════════════════════════════════════════════════════════════
   * 🗺️ MapTab.vue - MapLibre GL JS 台灣縣市 3D 地圖組件
   * ═══════════════════════════════════════════════════════════════════════════
   *
   * @fileoverview
   * 這是一個基於 MapLibre GL JS 的台灣縣市 3D 地圖視覺化組件。
   * 本組件負責載入、處理和渲染台灣縣市邊界的 GeoJSON 數據，並支持 3D 視角。
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 📋 核心功能
   * ─────────────────────────────────────────────────────────────────────────
   * 1. 縣市邊界渲染：
   *    ✓ 載入 直轄市、縣(市)界線1140318.geojson
   *    ✓ 以 3D extrusion 方式繪製所有台灣縣市邊界
   *
   * 2. 視覺元素：
   *    ✓ 3D 立體縣市區域
   *    ✓ 黑色縣市邊界線
   *    ✓ 灰色地圖背景
   *
   * 3. 交互功能：
   *    ✓ 滾輪縮放控制
   *    ✓ 拖動平移導航
   *    ✓ 右鍵拖動旋轉視角（3D）
   *    ✓ 傾斜視角控制
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 🎨 配色主題
   * ─────────────────────────────────────────────────────────────────────────
   * 灰色      #808080  → 地圖背景
   * 黑色      #000000  → 縣市邊框
   * 白色/藍色漸層      → 3D 縣市填充
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 🛠️ 技術棧
   * ─────────────────────────────────────────────────────────────────────────
   * @requires vue                 - Vue 3.2+ (Composition API)
   * @requires maplibre-gl         - MapLibre GL JS (3D 地圖庫)
   * @requires @/stores/dataStore  - Pinia 狀態管理
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 📁 數據來源
   * ─────────────────────────────────────────────────────────────────────────
   * 縣市邊界數據：直轄市、縣(市)界線1140318.geojson
   * 路徑：public/data/geojson/直轄市、縣(市)界線1140318.geojson
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 🔧 使用方式
   * ─────────────────────────────────────────────────────────────────────────
   * <MapTab @map-ready="handleMapReady" />
   *
   * @event map-ready - 地圖初始化完成時觸發，返回地圖實例
   *
   * ─────────────────────────────────────────────────────────────────────────
   * 📝 維護者
   * ─────────────────────────────────────────────────────────────────────────
   * @author Kevin Cheng
   * @version 4.0.0
   * @since 2025
   * @license MIT
   *
   * ═══════════════════════════════════════════════════════════════════════════
   */

  // ═══════════════════════════════════════════════════════════════════════════
  // 📦 依賴導入 (Dependencies Import)
  // ═══════════════════════════════════════════════════════════════════════════

  // Vue 3 核心功能
  import { ref, onMounted, onUnmounted, nextTick } from 'vue';

  // MapLibre GL JS
  import maplibregl from 'maplibre-gl';
  import 'maplibre-gl/dist/maplibre-gl.css';

  // Pinia 狀態管理
  import { useDataStore } from '@/stores/dataStore';

  // ═══════════════════════════════════════════════════════════════════════════
  // 🎯 組件定義 (Component Definition)
  // ═══════════════════════════════════════════════════════════════════════════

  export default {
    name: 'MapTab',

    // 組件觸發的事件
    emits: [
      'map-ready', // 地圖初始化完成時觸發，傳遞地圖實例
    ],

    /**
     * ───────────────────────────────────────────────────────────────────────
     * 🎬 組件設置函數 (Component Setup Function)
     * ───────────────────────────────────────────────────────────────────────
     * 使用 Vue 3 Composition API 設置組件邏輯
     *
     * @param {Object} _ - Props（本組件不使用）
     * @param {Object} context - 設置上下文
     * @param {Function} context.emit - 事件觸發函數
     * @returns {Object} 返回模板可用的響應式數據和方法
     */
    setup(_, { emit }) {
      // ═══════════════════════════════════════════════════════════════════════
      // 📦 狀態管理與依賴 (State Management & Dependencies)
      // ═══════════════════════════════════════════════════════════════════════

      // Pinia 數據存儲
      const dataStore = useDataStore();

      // ═══════════════════════════════════════════════════════════════════════
      // 🗺️ 地圖相關變數 (Map-Related Variables)
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * 地圖 DOM 容器引用
       * @type {Ref<HTMLElement|null>}
       */
      const mapContainer = ref(null);

      /**
       * MapLibre GL 地圖實例
       * @type {maplibregl.Map|null}
       */
      let map = null;

      /**
       * Popup 實例
       * @type {maplibregl.Popup|null}
       */
      let popup = null;

      // ═══════════════════════════════════════════════════════════════════════
      // 🎛️ 控制狀態 (Control States)
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * 地圖就緒狀態標記
       * true = 地圖已初始化完成，false = 尚未初始化
       * @type {Ref<boolean>}
       */
      const isMapReady = ref(false);

      /**
       * 地圖容器唯一 ID
       * 使用隨機字符串確保多實例時不會衝突
       * @type {Ref<string>}
       */
      const mapContainerId = ref(`maplibre-map-${Math.random().toString(36).substr(2, 9)}`);

      // ═══════════════════════════════════════════════════════════════════════
      // 📊 GeoJSON 數據儲存 (GeoJSON Data Storage)
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * 縣市 GeoJSON 數據
       * 來源：直轄市、縣(市)界線1140318.geojson
       * @type {Ref<Object|null>}
       */
      const countyData = ref(null);

      /**
       * 📥 載入台灣縣市 GeoJSON 數據
       */
      const loadCountyData = async () => {
        try {
          console.log('[MapTab] 開始載入台灣縣市 GeoJSON 數據...');

          // 載入縣市 GeoJSON 檔案
          const countyResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/直轄市、縣(市)界線1140318.geojson`
          );

          // 檢查響應
          if (!countyResponse.ok) {
            throw new Error(`縣市數據載入失敗: HTTP ${countyResponse.status}`);
          }

          // 解析 JSON
          countyData.value = await countyResponse.json();

          console.log('[MapTab] 台灣縣市數據載入成功');
          console.log('  - 縣市數量:', countyData.value.features?.length || 0);

          return true;
        } catch (error) {
          console.error('[MapTab] 台灣縣市數據載入失敗:', error);
          return false;
        }
      };

      /**
       * 🗺️ 添加 3D 縣市圖層
       */
      const add3DCountyLayers = () => {
        if (!map || !countyData.value) {
          console.error('[MapTab] 無法添加圖層: map=', !!map, 'countyData=', !!countyData.value);
          return;
        }

        try {
          console.log('[MapTab] 開始添加 3D 台灣縣市圖層');

          // 添加數據源
          map.addSource('counties', {
            type: 'geojson',
            data: countyData.value,
          });

          // 添加 3D extrusion 圖層
          map.addLayer({
            id: 'counties-3d',
            type: 'fill-extrusion',
            source: 'counties',
            paint: {
              'fill-extrusion-color': [
                'match',
                ['get', 'COUNTYNAME'],
                '臺北市',
                '#FF6B6B',
                '新北市',
                '#4ECDC4',
                '基隆市',
                '#45B7D1',
                '桃園市',
                '#96CEB4',
                '新竹市',
                '#FFEAA7',
                '新竹縣',
                '#DFE6E9',
                '苗栗縣',
                '#74B9FF',
                '臺中市',
                '#A29BFE',
                '彰化縣',
                '#FD79A8',
                '南投縣',
                '#FDCB6E',
                '雲林縣',
                '#6C5CE7',
                '嘉義市',
                '#00B894',
                '嘉義縣',
                '#00CEC9',
                '臺南市',
                '#E17055',
                '高雄市',
                '#0984E3',
                '屏東縣',
                '#55EFC4',
                '宜蘭縣',
                '#A8E6CF',
                '花蓮縣',
                '#FFD93D',
                '臺東縣',
                '#FF8B94',
                '澎湖縣',
                '#B4A7D6',
                '金門縣',
                '#F3A683',
                '連江縣',
                '#81ECEC',
                // 預設顏色（以防萬一）
                '#CCCCCC',
              ],
              'fill-extrusion-height': 50000, // 3D 高度 (米)
              'fill-extrusion-base': 0,
              'fill-extrusion-opacity': 0.8,
            },
          });

          // 添加縣市邊界線圖層
          map.addLayer({
            id: 'counties-outline',
            type: 'line',
            source: 'counties',
            paint: {
              'line-color': '#000000',
              'line-width': 2,
            },
          });

          // 創建持久的 popup 實例
          popup = new maplibregl.Popup({
            closeButton: false,
            closeOnClick: false,
            className: 'county-popup',
          });

          // 添加懸停效果
          map.on('mousemove', 'counties-3d', (e) => {
            map.getCanvas().style.cursor = 'pointer';

            if (e.features && e.features.length > 0) {
              const feature = e.features[0];
              const countyName = feature.properties.COUNTYNAME || '未知縣市';

              // 更新 popup 位置和內容
              popup.setLngLat(e.lngLat).setHTML(`<strong>${countyName}</strong>`).addTo(map);
            }
          });

          map.on('mouseleave', 'counties-3d', () => {
            map.getCanvas().style.cursor = '';
            // 移除 popup
            if (popup) {
              popup.remove();
            }
          });

          console.log('[MapTab] 3D 台灣縣市圖層添加完成');
        } catch (error) {
          console.error('[MapTab] 3D 台灣縣市圖層添加失敗:', error);
        }
      };

      /**
       * 🏗️ 創建地圖實例
       * 初始化 MapLibre GL 地圖並設定基本配置
       */
      const createMap = () => {
        if (!mapContainer.value) return false;

        const rect = mapContainer.value.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
          console.warn('[MapTab] 容器尺寸為零，延遲初始化');
          return false;
        }

        try {
          console.log('[MapTab] 開始創建 MapLibre GL 地圖');

          // 創建地圖實例
          map = new maplibregl.Map({
            container: mapContainer.value,
            style: {
              version: 8,
              sources: {
                'osm-tiles': {
                  type: 'raster',
                  tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                  tileSize: 256,
                  attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                },
              },
              layers: [
                {
                  id: 'background',
                  type: 'background',
                  paint: {
                    'background-color': '#808080', // 灰色背景
                  },
                },
                {
                  id: 'osm-tiles-layer',
                  type: 'raster',
                  source: 'osm-tiles',
                  minzoom: 0,
                  maxzoom: 22,
                },
              ],
            },
            center: [120.9, 23.7], // 台灣中心座標
            zoom: 6.8,
            pitch: 60, // 傾斜角度 (3D 視角)
            bearing: 0, // 旋轉角度
            antialias: true, // 抗鋸齒
          });

          // 添加導航控制器 (縮放按鈕)
          map.addControl(new maplibregl.NavigationControl(), 'top-right');

          // 地圖載入完成後的處理
          map.on('load', () => {
            console.log('[MapTab] MapLibre GL 地圖載入完成');
            isMapReady.value = true;

            // 添加 3D 縣市圖層
            add3DCountyLayers();

            // 保存地圖實例到 store
            dataStore.setMapInstance(map);

            // 將地圖實例傳遞給父組件
            emit('map-ready', map);
          });

          console.log('[MapTab] MapLibre GL 地圖創建成功');
          return true;
        } catch (error) {
          console.error('[MapTab] MapLibre GL 地圖創建失敗:', error);
          return false;
        }
      };

      /**
       * 🚀 初始化地圖
       * 創建地圖並載入初始數據
       */
      const initMap = async () => {
        let attempts = 0;
        const maxAttempts = 20;

        // 載入台灣縣市數據
        const loaded = await loadCountyData();
        if (!loaded) {
          console.error('[MapTab] 無法載入台灣縣市數據');
          return;
        }

        const tryCreateMap = async () => {
          if (attempts >= maxAttempts) {
            console.error('[MapTab] 地圖初始化失敗，已達到最大嘗試次數');
            return;
          }

          attempts++;
          console.log(`[MapTab] 嘗試創建地圖 (${attempts}/${maxAttempts})`);

          if (createMap()) {
            console.log('[MapTab] 地圖創建成功');
          } else {
            console.log('[MapTab] 地圖創建失敗，100ms 後重試');
            setTimeout(tryCreateMap, 100);
          }
        };

        tryCreateMap();
      };

      // 🧹 生命週期：組件掛載
      onMounted(() => {
        nextTick(() => {
          initMap();
        });
      });

      // 🧹 生命週期：組件卸載
      onUnmounted(() => {
        if (popup) {
          popup.remove();
          popup = null;
        }
        if (map) {
          map.remove();
          map = null;
        }
        isMapReady.value = false;
      });

      // 📤 返回組件公開的屬性和方法
      return {
        mapContainer,
        mapContainerId,
      };
    },
  };
</script>

<template>
  <!-- 🗺️ 地圖主容器 -->
  <div id="map-container" class="h-100 w-100 position-relative bg-transparent z-0">
    <!-- 🗺️ MapLibre GL 地圖容器 -->
    <div :id="mapContainerId" ref="mapContainer" class="h-100 w-100"></div>
  </div>
</template>

<style scoped>
  @import '../assets/css/common.css';

  #map-container {
    overflow: hidden;
  }

  /* MapLibre GL 地圖容器樣式 */
  :deep(.maplibregl-map) {
    font-family: 'Open Sans', 'Arial', sans-serif;
  }

  /* MapLibre GL 控制器樣式 */
  :deep(.maplibregl-ctrl-group) {
    background: rgba(0, 43, 127, 0.95);
    border: 1px solid #ffc61e;
  }

  :deep(.maplibregl-ctrl button) {
    background-color: rgba(0, 43, 127, 0.95);
    color: #ffc61e;
  }

  :deep(.maplibregl-ctrl button:hover) {
    background-color: rgba(0, 43, 127, 1);
  }

  /* MapLibre GL Popup 樣式 */
  :deep(.maplibregl-popup-content) {
    background: rgba(0, 43, 127, 0.95);
    color: #ffc61e;
    border: 2px solid #ffc61e;
    border-radius: 4px;
    padding: 12px 16px;
    font-size: 14px;
  }

  :deep(.maplibregl-popup-tip) {
    border-top-color: rgba(0, 43, 127, 0.95);
  }

  :deep(.maplibregl-popup-close-button) {
    color: #ffc61e;
    font-size: 20px;
    padding: 0 8px;
  }

  :deep(.maplibregl-popup-close-button:hover) {
    background-color: transparent;
    color: #ffffff;
  }
</style>
