<script>
  /* eslint-disable no-console */
  /**
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   * ğŸ—ºï¸ MapTab.vue - CesiumJS å°ç£ç¸£å¸‚ 3D åœ°åœ–çµ„ä»¶
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   *
   * @fileoverview
   * é€™æ˜¯ä¸€å€‹åŸºæ–¼ CesiumJS çš„å°ç£ç¸£å¸‚ 3D åœ°åœ–è¦–è¦ºåŒ–çµ„ä»¶ã€‚
   * æœ¬çµ„ä»¶è² è²¬è¼‰å…¥ã€è™•ç†å’Œæ¸²æŸ“å°ç£ç¸£å¸‚é‚Šç•Œçš„ GeoJSON æ•¸æ“šï¼Œä¸¦æ”¯æŒ 3D è¦–è§’ã€‚
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 1. ç¸£å¸‚é‚Šç•Œæ¸²æŸ“ï¼š
   *    âœ“ è¼‰å…¥ ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   *    âœ“ ä»¥ 3D extrusion æ–¹å¼ç¹ªè£½æ‰€æœ‰å°ç£ç¸£å¸‚é‚Šç•Œ
   *    âœ“ æ¯å€‹ç¸£å¸‚ä½¿ç”¨ä¸åŒé¡è‰²
   *
   * 2. è¦–è¦ºå…ƒç´ ï¼š
   *    âœ“ 3D ç«‹é«”ç¸£å¸‚å€åŸŸï¼ˆ22ç¨®ä¸åŒé¡è‰²ï¼‰
   *    âœ“ ç™½è‰²ç¸£å¸‚é‚Šç•Œç·š
   *    âœ“ Bing Maps è¡›æ˜Ÿåœ–åº•åœ–ï¼ˆçœŸå¯¦åœ°å½¢å½±åƒï¼‰
   *    âœ“ çœŸå¯¦åœ°å½¢é«˜åº¦ï¼ˆä½¿ç”¨ Cesium World Terrainï¼‰
   *    âœ“ æ ¸é›»å» ä½ç½®æ¨™è¨˜ï¼ˆç´…è‰²åœ“é»ï¼‰
   *    âœ“ æ ¸é›»å»  30 å…¬é‡Œç´…è‰²åœ“åœˆ
   *    âœ“ æ ¸é›»å» å½±éŸ¿ç¯„åœç«‹é«”åŠçƒï¼ˆå¹³æ»‘çš„åŠåœ“çƒï¼‰
   *    âœ“ æ ¸é›»å» åç¨±æ¨™ç±¤ï¼ˆç´…è‰²æ–‡å­—ï¼‰
   *
   * 3. äº¤äº’åŠŸèƒ½ï¼š
   *    âœ“ æ»¾è¼ªç¸®æ”¾æ§åˆ¶
   *    âœ“ æ‹–å‹•å¹³ç§»å°èˆª
   *    âœ“ å³éµæ‹–å‹•æ—‹è½‰è¦–è§’ï¼ˆæ”¯æ´ 3Dï¼‰
   *    âœ“ å‚¾æ–œè¦–è§’æ§åˆ¶
   *    âœ“ é è¨­å¾æ­£ä¸Šæ–¹å¾€ä¸‹çœ‹ï¼ˆä¿¯è¦–è¦–è§’ï¼‰
   *    âœ“ æ¯å€‹ç¸£å¸‚éš¨æ©Ÿé«˜åº¦ï¼ˆ30-80 å…¬é‡Œï¼‰
   *    âœ“ ç„¡æ‡¸åœæ•ˆæœï¼ˆå·²ç§»é™¤æ‰€æœ‰ popup å’Œæ»‘é¼ äº¤äº’ï¼‰
   *    âœ“ ç„¡åœ°åœ–æ§ä»¶æŒ‰éˆ•ï¼ˆå·²ç§»é™¤æ‰€æœ‰å°èˆªæ§åˆ¶å™¨ï¼‰
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * âš›ï¸ æ ¸é›»å» æ¨™è¨˜
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * æ ¸ä¸€å» ï¼ˆå·²é™¤å½¹ï¼‰ï¼šåŒ—ç·¯25Â°17â€²50.7â€³ï¼Œæ±ç¶“121Â°32â€²44.2â€³
   * æ ¸äºŒå» ï¼ˆå·²é™¤å½¹ï¼‰ï¼šåŒ—ç·¯25Â°12â€²0.5â€³ï¼Œæ±ç¶“121Â°40â€²17.3â€³
   * æ ¸ä¸‰å» ï¼ˆé‹è½‰ä¸­ï¼‰ï¼šåŒ—ç·¯21Â°59â€²47.5â€³ï¼Œæ±ç¶“120Â°45â€²39.8â€³
   * æ ¸å››å» ï¼ˆå°å­˜ä¸­ï¼‰ï¼šåŒ—ç·¯25Â°02â€²18â€³ï¼Œæ±ç¶“121Â°55â€²27â€³
   *
   * æ¯åº§æ ¸é›»å» æ¨™è¨˜åŒ…å«ï¼š
   * - ç´…è‰²åœ“é»æ¨™è¨˜
   * - ç«‹é«”åŠçƒå½±éŸ¿ç¯„åœï¼ˆå¹³æ»‘çš„åŠåœ“çƒï¼‰
   * - åç¨±æ¨™ç±¤ï¼ˆç´…è‰²æ–‡å­—ï¼‰
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ¨ é…è‰²ä¸»é¡Œ
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * æ¯å€‹ç¸£å¸‚éƒ½æœ‰ç¨ç‰¹çš„é¡è‰²é…ç½®ï¼š
   * è‡ºåŒ—å¸‚ â†’ #FF6B6B (ç´…è‰²ç³»)
   * æ–°åŒ—å¸‚ â†’ #4ECDC4 (é’ç¶ è‰²)
   * åŸºéš†å¸‚ â†’ #45B7D1 (å¤©è—è‰²)
   * æ¡ƒåœ’å¸‚ â†’ #96CEB4 (è–„è·ç¶ )
   * æ–°ç«¹å¸‚ â†’ #FFEAA7 (æ·¡é»ƒè‰²)
   * æ–°ç«¹ç¸£ â†’ #DFE6E9 (æ·¡ç°è‰²)
   * è‹—æ —ç¸£ â†’ #74B9FF (è—è‰²)
   * è‡ºä¸­å¸‚ â†’ #A29BFE (ç´«è‰²)
   * å½°åŒ–ç¸£ â†’ #FD79A8 (ç²‰ç´…è‰²)
   * å—æŠ•ç¸£ â†’ #FDCB6E (é‡‘é»ƒè‰²)
   * é›²æ—ç¸£ â†’ #6C5CE7 (æ·±ç´«è‰²)
   * å˜‰ç¾©å¸‚ â†’ #00B894 (ç¶ è‰²)
   * å˜‰ç¾©ç¸£ â†’ #00CEC9 (è—ç¶ è‰²)
   * è‡ºå—å¸‚ â†’ #E17055 (æ©˜ç´…è‰²)
   * é«˜é›„å¸‚ â†’ #0984E3 (è—è‰²)
   * å±æ±ç¸£ â†’ #55EFC4 (æ·¡ç¶ è‰²)
   * å®œè˜­ç¸£ â†’ #A8E6CF (æ·ºç¶ è‰²)
   * èŠ±è“®ç¸£ â†’ #FFD93D (é»ƒè‰²)
   * è‡ºæ±ç¸£ â†’ #FF8B94 (ç²‰è‰²)
   * æ¾æ¹–ç¸£ â†’ #B4A7D6 (æ·¡ç´«è‰²)
   * é‡‘é–€ç¸£ â†’ #F3A683 (æ¡ƒè‰²)
   * é€£æ±Ÿç¸£ â†’ #81ECEC (é’è‰²)
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ› ï¸ æŠ€è¡“æ£§
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @requires vue                 - Vue 3.2+ (Composition API)
   * @requires cesium              - CesiumJS (3D åœ°åœ–åº«)
   * @requires @/stores/dataStore  - Pinia ç‹€æ…‹ç®¡ç†
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ æ•¸æ“šä¾†æº
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ç¸£å¸‚é‚Šç•Œæ•¸æ“šï¼šç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   * è·¯å¾‘ï¼špublic/data/geojson/ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ”§ ä½¿ç”¨æ–¹å¼
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * <MapTab @map-ready="handleMapReady" />
   *
   * @event map-ready - åœ°åœ–åˆå§‹åŒ–å®Œæˆæ™‚è§¸ç™¼ï¼Œè¿”å›åœ°åœ–å¯¦ä¾‹
   *
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ğŸ“ ç¶­è­·è€…
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * @author Kevin Cheng
   * @version 23.0.0
   * @since 2025
   * @license MIT
   *
   * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   */

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ ä¾è³´å°å…¥ (Dependencies Import)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // å¾ Vue 3 æ ¸å¿ƒåº«å°å…¥ Composition API æ‰€éœ€çš„åŠŸèƒ½
  import { ref, onMounted, onUnmounted, nextTick } from 'vue';

  // å°å…¥ CesiumJS åœ°åœ–åº«
  import * as Cesium from 'cesium';

  // å¾ Pinia ç‹€æ…‹ç®¡ç†å°å…¥æ•¸æ“šå­˜å„²
  import { useDataStore } from '@/stores/dataStore';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ¯ çµ„ä»¶å®šç¾© (Component Definition)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  export default {
    name: 'MapTab',

    emits: ['map-ready'],

    setup(_, { emit }) {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¦ ç‹€æ…‹ç®¡ç†èˆ‡ä¾è³´ (State Management & Dependencies)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const dataStore = useDataStore();

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ—ºï¸ åœ°åœ–ç›¸é—œè®Šæ•¸ (Map-Related Variables)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const mapContainer = ref(null);
      let viewer = null;
      const isMapReady = ref(false);
      const mapContainerId = ref(`cesium-map-${Math.random().toString(36).substr(2, 9)}`);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“Š GeoJSON æ•¸æ“šå„²å­˜ (GeoJSON Data Storage)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const countyData = ref(null);

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¥ è¼‰å…¥å°ç£ç¸£å¸‚ GeoJSON æ•¸æ“š
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const loadCountyData = async () => {
        try {
          console.log('[MapTab] é–‹å§‹è¼‰å…¥å°ç£ç¸£å¸‚ GeoJSON æ•¸æ“š...');

          const countyResponse = await fetch(
            `${process.env.BASE_URL}data/geojson/ç›´è½„å¸‚ã€ç¸£(å¸‚)ç•Œç·š1140318.geojson`
          );

          if (!countyResponse.ok) {
            throw new Error(`ç¸£å¸‚æ•¸æ“šè¼‰å…¥å¤±æ•—: HTTP ${countyResponse.status}`);
          }

          countyData.value = await countyResponse.json();

          console.log('[MapTab] å°ç£ç¸£å¸‚æ•¸æ“šè¼‰å…¥æˆåŠŸ');
          console.log('  - ç¸£å¸‚æ•¸é‡:', countyData.value.features?.length || 0);

          return true;
        } catch (error) {
          console.error('[MapTab] å°ç£ç¸£å¸‚æ•¸æ“šè¼‰å…¥å¤±æ•—:', error);
          return false;
        }
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âš›ï¸ æ·»åŠ æ ¸é›»å» æ¨™è¨˜å’Œå½±éŸ¿ç¯„åœçƒé«”
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const addNuclearPlants = () => {
        const buildCircleDegreesArray = (centerLon, centerLat, radiusMeters, segments = 180) => {
          const latRad = Cesium.Math.toRadians(centerLat);
          const metersPerDegreeLat = 111320; // approximate
          const metersPerDegreeLon = 111320 * Math.cos(latRad); // approximate
          const points = [];
          for (let i = 0; i <= segments; i++) {
            const theta = (i / segments) * Math.PI * 2;
            const dx = (radiusMeters * Math.cos(theta)) / metersPerDegreeLon;
            const dy = (radiusMeters * Math.sin(theta)) / metersPerDegreeLat;
            points.push(centerLon + dx, centerLat + dy);
          }
          return points;
        };
        const plants = [
          {
            name: 'æ ¸ä¸€å» ',
            fullName: 'æ ¸ä¸€å» ï¼ˆå·²é™¤å½¹ï¼‰',
            status: 'å·²é™¤å½¹',
            lon: 121.545611,
            lat: 25.297417,
          },
          {
            name: 'æ ¸äºŒå» ',
            fullName: 'æ ¸äºŒå» ï¼ˆå·²é™¤å½¹ï¼‰',
            status: 'å·²é™¤å½¹',
            lon: 121.671472,
            lat: 25.200139,
          },
          {
            name: 'æ ¸ä¸‰å» ',
            fullName: 'æ ¸ä¸‰å» ',
            status: 'é‹è½‰ä¸­',
            lon: 120.761056,
            lat: 21.996528,
          },
          {
            name: 'æ ¸å››å» ',
            fullName: 'æ ¸å››å» ï¼ˆå°å­˜ä¸­ï¼‰',
            status: 'å°å­˜ä¸­',
            lon: 121.924167,
            lat: 25.038333,
          },
        ];

        plants.forEach((plant) => {
          // æ·»åŠ æ ¸é›»å» æ¨™è¨˜é»ï¼ˆä¸é¡¯ç¤ºæ¨™ç±¤ï¼‰
          viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(plant.lon, plant.lat),
            point: {
              pixelSize: 8,
              color: Cesium.Color.RED,
              outlineColor: Cesium.Color.WHITE,
              outlineWidth: 1,
              heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
            },
          });

          // æ·»åŠ  30 å…¬é‡Œå½±éŸ¿ç¯„åœåœ“åœˆï¼ˆç´…è‰²å¯¦ç·šé‚Šæ¡†ï¼Œæ¡ç”¨åœ°è²¼æŠ˜ç·šæ›´ç©©å®šï¼‰
          const circleDegrees = buildCircleDegreesArray(plant.lon, plant.lat, 30000, 256);
          viewer.entities.add({
            polyline: {
              positions: Cesium.Cartesian3.fromDegreesArray(circleDegrees),
              width: 5,
              material: Cesium.Color.RED,
              clampToGround: true,
            },
          });

          // æ·»åŠ ç«‹é«”åŠçƒå½±éŸ¿ç¯„åœ
          const layers = 50;
          const sphereRadius = 30000;

          for (let layer = 0; layer < layers; layer++) {
            const heightOffset = (layer / (layers - 1)) * sphereRadius;
            const radiusSquared = sphereRadius * sphereRadius - heightOffset * heightOffset;

            if (radiusSquared < 0) continue;

            const currentRadius = Math.sqrt(radiusSquared);
            const opacity = 0.025 - (layer / layers) * 0.01;

            viewer.entities.add({
              position: Cesium.Cartesian3.fromDegrees(plant.lon, plant.lat, heightOffset),
              ellipse: {
                semiMajorAxis: currentRadius,
                semiMinorAxis: currentRadius,
                material: Cesium.Color.RED.withAlpha(opacity),
                height: heightOffset,
                heightReference: Cesium.HeightReference.NONE,
              },
            });
          }
        });

        console.log('[MapTab] æ ¸é›»å» æ¨™è¨˜å’Œç«‹é«”åŠçƒæ·»åŠ å®Œæˆ');
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ—ºï¸ æ·»åŠ  3D ç¸£å¸‚åœ–å±¤
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const add3DCountyLayers = () => {
        if (!viewer || !countyData.value) {
          console.error(
            '[MapTab] ç„¡æ³•æ·»åŠ åœ–å±¤: viewer=',
            !!viewer,
            'countyData=',
            !!countyData.value
          );
          return;
        }

        try {
          console.log('[MapTab] é–‹å§‹æ·»åŠ  3D å°ç£ç¸£å¸‚åœ–å±¤');

          countyData.value.features.forEach((feature) => {
            const geometry = feature.geometry;

            // è™•ç† Polygon å’Œ MultiPolygon çš„ä¸åŒæƒ…æ³
            const polygons =
              geometry.type === 'Polygon' ? [geometry.coordinates] : geometry.coordinates;

            polygons.forEach((polygonCoords) => {
              // fromDegreesArray éœ€è¦ä¸€å€‹æ‰å¹³çš„ [lon, lat, lon, lat, ...] é™£åˆ—
              const flatCoordinates = polygonCoords[0].flat();

              viewer.entities.add({
                polyline: {
                  positions: Cesium.Cartesian3.fromDegreesArray(flatCoordinates),
                  width: 2,
                  material: Cesium.Color.WHITE,
                  clampToGround: true,
                },
              });
            });
          });

          console.log('[MapTab] 3D å°ç£ç¸£å¸‚åœ–å±¤æ·»åŠ å®Œæˆ');
        } catch (error) {
          console.error('[MapTab] 3D å°ç£ç¸£å¸‚åœ–å±¤æ·»åŠ å¤±æ•—:', error);
        }
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ—ï¸ å‰µå»º CesiumJS åœ°åœ–å¯¦ä¾‹
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const createMap = async () => {
        if (!mapContainer.value) return false;

        const rect = mapContainer.value.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) {
          console.warn('[MapTab] å®¹å™¨å°ºå¯¸ç‚ºé›¶ï¼Œå»¶é²åˆå§‹åŒ–');
          return false;
        }

        try {
          console.log('[MapTab] é–‹å§‹å‰µå»º CesiumJS åœ°åœ–');

          // è¨­ç½® CesiumJS token
          Cesium.Ion.defaultAccessToken =
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIxYjJiZjlhZC1mZDNkLTRiZWEtYjExNy1iZDI1OWQ5ZmJlZmEiLCJpZCI6MzU1MDgxLCJpYXQiOjE3NjE3MTc5NTl9.ivNUz20WJNOvyTB6vzB8xHNWNSzgl06vBAGOuZLNKs4';

          // å‰µå»ºåœ°å½¢æä¾›è€…
          const terrainProvider = await Cesium.createWorldTerrainAsync();

          // å‰µå»º CesiumJS Viewer
          viewer = new Cesium.Viewer(mapContainer.value, {
            terrainProvider: terrainProvider,

            // ä¾ç…§æ–¹æ³•äºŒï¼šä¸æŒ‡å®š imageryProviderï¼Œè®“ Cesium é€é Ion é è¨­è¼‰å…¥ Bing è¡›æ˜Ÿåœ–
            baseLayerPicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: false,
            vrButton: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            selectionIndicator: false,
            infoBox: false,
            navigationInstructionsInitiallyVisible: false,
          });

          // --- æ·±åº¦é™¤éŒ¯è¨­å®š ---
          // 1. é–‹å•Ÿ FPS åµéŒ¯å™¨ï¼Œç¢ºèªæ¸²æŸ“å¾ªç’°æ˜¯å¦æ­£å¸¸
          viewer.scene.debugShowFramesPerSecond = true;

          // 2. å¼·åˆ¶é¡¯ç¤ºåœ°çƒ
          viewer.scene.globe.show = true;

          // 3. ç›£è½åº•åœ–åœ–å±¤çš„éŒ¯èª¤äº‹ä»¶
          viewer.imageryLayers.layerAdded.addEventListener((layer) => {
            layer.imageryProvider.errorEvent.addEventListener((error) => {
              console.error('[MapTab] åº•åœ–è¼‰å…¥å¤±æ•—:', error);
            });
          });

          // è¨­ç½®åˆå§‹è¦–è§’ - èª¿æ•´è§’åº¦ä»¥é¡¯ç¤ºåœ°å½¢é«˜åº¦
          viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(120.9, 23.0, 250000), // é™ä½é«˜åº¦è‡³ 250km
            orientation: {
              heading: Cesium.Math.toRadians(0),
              pitch: Cesium.Math.toRadians(-60), // å‚¾æ–œè¦–è§’ä»¥è§€å¯Ÿåœ°å½¢
              roll: 0.0,
            },
          });

          // è¨­ç½®ç›¸æ©Ÿæ§åˆ¶
          viewer.scene.screenSpaceCameraController.enableRotate = true;
          viewer.scene.screenSpaceCameraController.enableTranslate = true;
          viewer.scene.screenSpaceCameraController.enableZoom = true;
          viewer.scene.screenSpaceCameraController.enableTilt = true;

          // å•Ÿç”¨å°åœ°å½¢çš„æ·±åº¦æ¸¬è©¦ï¼Œç¢ºä¿ 3D ç‰©ä»¶æ­£ç¢ºè²¼åˆåœ°å½¢
          viewer.scene.globe.depthTestAgainstTerrain = true;

          // åœ°å½¢é«˜åº¦æ”¾å¤§10å€
          viewer.scene.globe.terrainExaggeration = 10.0;

          // å¼·åˆ¶èª¿æ•´ CesiumJS ç•«å¸ƒå¤§å°
          const container = viewer.container;
          const canvas = viewer.canvas;
          console.log('[MapTab] å®¹å™¨å¤§å°:', {
            container: {
              width: container.clientWidth,
              height: container.clientHeight,
              offsetWidth: container.offsetWidth,
              offsetHeight: container.offsetHeight,
            },
            canvas: {
              width: canvas.width,
              height: canvas.height,
              clientWidth: canvas.clientWidth,
              clientHeight: canvas.clientHeight,
            },
            window: {
              innerWidth: window.innerWidth,
              innerHeight: window.innerHeight,
            },
          });

          // å¼·åˆ¶èª¿æ•´ç•«å¸ƒå¤§å°
          viewer.resize();

          console.log('[MapTab] CesiumJS åœ°åœ–å‰µå»ºæˆåŠŸ');
          isMapReady.value = true;

          // æ·»åŠ  3D ç¸£å¸‚åœ–å±¤
          add3DCountyLayers();

          // æ·»åŠ æ ¸é›»å» æ¨™è¨˜å’Œå½±éŸ¿ç¯„åœ
          addNuclearPlants();

          // ä¿å­˜åœ°åœ–å¯¦ä¾‹åˆ° Pinia store
          dataStore.setMapInstance(viewer);

          // å°‡åœ°åœ–å¯¦ä¾‹å‚³éçµ¦çˆ¶çµ„ä»¶
          emit('map-ready', viewer);

          return true;
        } catch (error) {
          console.error('[MapTab] CesiumJS åœ°åœ–å‰µå»ºå¤±æ•—:', error);
          return false;
        }
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸš€ åˆå§‹åŒ–åœ°åœ–
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const initMap = async () => {
        let attempts = 0;
        const maxAttempts = 20;

        // è¼‰å…¥å°ç£ç¸£å¸‚æ•¸æ“š
        const loaded = await loadCountyData();
        if (!loaded) {
          console.error('[MapTab] ç„¡æ³•è¼‰å…¥å°ç£ç¸£å¸‚æ•¸æ“š');
          return;
        }

        const tryCreateMap = async () => {
          if (attempts >= maxAttempts) {
            console.error('[MapTab] åœ°åœ–åˆå§‹åŒ–å¤±æ•—ï¼Œå·²é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸');
            return;
          }

          attempts++;
          console.log(`[MapTab] å˜—è©¦å‰µå»ºåœ°åœ– (${attempts}/${maxAttempts})`);

          try {
            const success = await createMap();
            if (success) {
              console.log('[MapTab] åœ°åœ–å‰µå»ºæˆåŠŸ');
            } else {
              console.log('[MapTab] åœ°åœ–å‰µå»ºå¤±æ•—ï¼Œ100ms å¾Œé‡è©¦');
              setTimeout(tryCreateMap, 100);
            }
          } catch (error) {
            console.error('[MapTab] åœ°åœ–å‰µå»ºéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
            console.log('[MapTab] 100ms å¾Œé‡è©¦');
            setTimeout(tryCreateMap, 100);
          }
        };

        tryCreateMap();
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ§¹ ç”Ÿå‘½é€±æœŸé‰¤å­ (Lifecycle Hooks)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      onMounted(() => {
        nextTick(() => {
          initMap();
        });

        // ç›£è½çª—å£å¤§å°æ”¹è®Š
        const handleResize = () => {
          if (viewer) {
            console.log('[MapTab] çª—å£å¤§å°æ”¹è®Šï¼Œèª¿æ•´åœ°åœ–å¤§å°');
            viewer.resize();
          }
        };

        window.addEventListener('resize', handleResize);

        // æ¸…ç†ç›£è½å™¨
        onUnmounted(() => {
          window.removeEventListener('resize', handleResize);
        });
      });

      onUnmounted(() => {
        if (viewer) {
          viewer.destroy();
          viewer = null;
        }
        isMapReady.value = false;
      });

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¤ è¿”å›çµ„ä»¶å…¬é–‹çš„å±¬æ€§å’Œæ–¹æ³•
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      return {
        mapContainer,
        mapContainerId,
      };
    },
  };
</script>

<template>
  <div id="map-container">
    <div :id="mapContainerId" ref="mapContainer"></div>
  </div>
</template>

<style>
  @import '../assets/css/common.css';

  /* åœ°åœ–å®¹å™¨ - ä½¿ç”¨é scoped æ¨£å¼ç¢ºä¿æ­£ç¢ºæ‡‰ç”¨ */
  #map-container {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
    z-index: 0 !important;
    background: transparent !important;
  }

  #map-container > div {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* CesiumJS åœ°åœ–å®¹å™¨æ¨£å¼ */
  .cesium-viewer {
    font-family: 'Open Sans', 'Arial', sans-serif;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  .cesium-viewer-cesiumWidgetContainer {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
  }

  .cesium-widget {
    width: 100vw !important;
    height: 100vh !important;
  }

  .cesium-widget canvas {
    width: 100vw !important;
    height: 100vh !important;
  }

  /* CesiumJS æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
  .cesium-viewer-toolbar {
    background: rgba(0, 43, 127, 0.95);
    border: 1px solid #ffc61e;
  }

  .cesium-viewer-toolbar button {
    background-color: rgba(0, 43, 127, 0.95);
    color: #ffc61e;
  }

  .cesium-viewer-toolbar button:hover {
    background-color: rgba(0, 43, 127, 1);
  }
</style>
